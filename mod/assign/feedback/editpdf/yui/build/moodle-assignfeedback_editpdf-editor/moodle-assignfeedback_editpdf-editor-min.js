YUI.add("moodle-assignfeedback_editpdf-editor",function(d,E){var y=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax.php",K=M.cfg.wwwroot+"/mod/assign/feedback/editpdf/ajax_progress.php",p={DIALOGUE:"assignfeedback_editpdf_widget"},g={PREVIOUSBUTTON:".navigate-previous-button",NEXTBUTTON:" .navigate-next-button",SEARCHCOMMENTSBUTTON:".searchcommentsbutton",EXPCOLCOMMENTSBUTTON:".expcolcommentsbutton",SEARCHFILTER:".assignfeedback_editpdf_commentsearch input",SEARCHCOMMENTSLIST:".assignfeedback_editpdf_commentsearch ul",PAGESELECT:".navigate-page-select",LOADINGICON:".loading",PROGRESSBARCONTAINER:".progress-info.progress-striped",DRAWINGREGION:".drawingregion",DRAWINGCANVAS:".drawingcanvas",SAVE:".savebutton",COMMENTCOLOURBUTTON:".commentcolourbutton",COMMENTMENU:".commentdrawable a",ANNOTATIONCOLOURBUTTON:".annotationcolourbutton",DELETEANNOTATIONBUTTON:".deleteannotationbutton",WARNINGMESSAGECONTAINER:".warningmessages",ICONMESSAGECONTAINER:".infoicon",UNSAVEDCHANGESDIV:".assignfeedback_editpdf_warningmessages",UNSAVEDCHANGESINPUT:'input[name="assignfeedback_editpdf_haschanges"]',STAMPSBUTTON:".currentstampbutton",USERINFOREGION:'[data-region="user-info"]',ROTATELEFTBUTTON:".rotateleftbutton",ROTATERIGHTBUTTON:".rotaterightbutton",DIALOGUE:"."+p.DIALOGUE},e="rgba(200, 200, 255, 0.9)",J="rgba(200, 200, 255, 0.5)",v="rgb(51, 51, 51)",m={white:"rgb(255,255,255)",yellow:"rgb(255,236,174)",red:"rgb(249,181,179)",green:"rgb(214,234,178)",blue:"rgb(203,217,237)",clear:"rgba(255,255,255, 0)"},u={white:"rgb(255,255,255)",yellow:"rgb(255,207,53)",red:"rgb(239,69,64)",green:"rgb(152,202,62)",blue:"rgb(125,159,211)",black:"rgb(51,51,51)"},k=300,F={comment:".commentbutton",pen:".penbutton",line:".linebutton",rectangle:".rectanglebutton",oval:".ovalbutton",stamp:".stampbutton",select:".selectbutton",drag:".dragbutton",highlight:".highlightbutton"},A=4;var H=function(O,P){this.x=parseInt(O,10);this.y=parseInt(P,10);this.clip=function(Q){if(this.x<Q.x){this.x=Q.x}if(this.x>(Q.x+Q.width)){this.x=Q.x+Q.width}if(this.y<Q.y){this.y=Q.y}if(this.y>(Q.y+Q.height)){this.y=Q.y+Q.height}return this}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.point=H;var L=function(P,R,Q,O){this.x=P;this.y=R;this.width=Q;this.height=O;this.bound=function(W){var U=0,Y=0,T=0,X=0,V=0,S;for(V=0;V<W.length;V++){S=W[V];if(S.x<U||V===0){U=S.x}if(S.x>Y||V===0){Y=S.x}if(S.y<T||V===0){T=S.y}if(S.y>X||V===0){X=S.y}}this.x=U;this.y=T;this.width=Y-U;this.height=X-T;return this};this.has_min_width=function(){return(this.width>=5)};this.has_min_height=function(){return(this.height>=5)};this.set_min_width=function(){this.width=5};this.set_min_height=function(){this.height=5}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.rect=L;var G=function(){this.start=false;this.end=false;this.starttime=0;this.annotationstart=false;this.tool="drag";this.commentcolour="yellow";this.annotationcolour="red";this.stamp="";this.path=[]};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.edit=G;var I=function(O){this.editor=O;this.shapes=[];this.nodes=[];this.erase=function(){if(this.shapes){while(this.shapes.length>0){this.editor.graphic.removeShape(this.shapes.pop())}}if(this.nodes){while(this.nodes.length>0){this.nodes.pop().remove()}}};this.scroll_update=function(T,R){var Q,P,S;for(Q=0;Q<this.nodes.length;Q++){P=this.nodes[Q].getData("x");S=this.nodes[Q].getData("y");if(P!==undefined&&S!==undefined){this.nodes[Q].setX(parseInt(P,10)-T);this.nodes[Q].setY(parseInt(S,10)-R)}}};this.store_position=function(R,Q,U){var P,T,S;P=this.editor.get_dialogue_element(g.DRAWINGREGION);T=parseInt(P.get("scrollLeft"),10);S=parseInt(P.get("scrollTop"),10);R.setData("x",Q+T);R.setData("y",U+S)}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.drawable=I;var b=function(O){b.superclass.constructor.apply(this,[O])};b.NAME="annotation";b.ATTRS={};d.extend(b,d.Base,{editor:null,gradeid:0,pageno:0,x:0,y:0,endx:0,endy:0,path:"",type:"rect",colour:"red",drawable:false,initializer:function(O){this.editor=O.editor||null;this.gradeid=parseInt(O.gradeid,10)||0;this.pageno=parseInt(O.pageno,10)||0;this.x=parseInt(O.x,10)||0;this.y=parseInt(O.y,10)||0;this.endx=parseInt(O.endx,10)||0;this.endy=parseInt(O.endy,10)||0;this.path=O.path||"";this.type=O.type||"rect";this.colour=O.colour||"red";this.drawable=false},clean:function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),endx:parseInt(this.endx,10),endy:parseInt(this.endy,10),type:this.type,path:this.path,pageno:this.pageno,colour:this.colour}},draw_highlight:function(){var S,O=this.editor.get_dialogue_element(g.DRAWINGREGION),Q=this.editor.get_dialogue_element(g.DRAWINGCANVAS).getXY(),P;if(this.editor.currentannotation===this){S=new M.assignfeedback_editpdf.rect();S.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]);P=this.editor.graphic.addShape({type:d.Rect,width:S.width,height:S.height,stroke:{weight:A,color:e},fill:{color:J},x:S.x,y:S.y});this.drawable.shapes.push(P);var R=d.Node.create('<img src="'+M.util.image_url("trash","assignfeedback_editpdf")+'"/>'),T=d.Node.create('<a href="#" role="button"></a>');R.setAttrs({alt:M.util.get_string("deleteannotation","assignfeedback_editpdf")});R.setStyles({backgroundColor:"white"});T.addClass("deleteannotationbutton");T.append(R);O.append(T);T.setData("annotation",this);T.on("click",this.remove,this);T.on("key",this.remove,"space,enter",this);T.setX(Q[0]+S.x+S.width-18);T.setY(Q[1]+S.y+6);this.drawable.nodes.push(T)}return this.drawable},draw:function(){this.draw_highlight();return this.drawable},remove:function(Q){var P,O;Q.preventDefault();P=this.editor.pages[this.editor.currentpage].annotations;for(O=0;O<P.length;O++){if(P[O]===this){P.splice(O,1);if(this.drawable){this.drawable.erase()}this.editor.currentannotation=false;this.editor.save_current_page();return}}},move:function(S,R){var Q=S-this.x,P=R-this.y,O,T,W,V,U;this.x+=Q;this.y+=P;this.endx+=Q;this.endy+=P;if(this.path){O=[];T=this.path.split(":");d.each(T,function(X){W=X.split(",");V=parseInt(W[0],10);U=parseInt(W[1],10);O.push((V+Q)+","+(U+P))});this.path=O.join(":")}if(this.drawable){this.drawable.erase()}this.editor.drawables.push(this.draw())},draw_current_edit:function(P){var O=P&&false;return O},init_from_edit:function(P){var O=new M.assignfeedback_editpdf.rect();O.bound([P.start,P.end]);this.gradeid=this.editor.get("gradeid");this.pageno=this.editor.currentpage;this.x=O.x;this.y=O.y;this.endx=O.x+O.width;this.endy=O.y+O.height;this.colour=P.annotationcolour;this.path="";return(O.has_min_width()&&O.has_min_height())}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotation=b;var x=function(O){x.superclass.constructor.apply(this,[O])};x.NAME="annotationline";x.ATTRS={};d.extend(x,M.assignfeedback_editpdf.annotation,{draw:function(){var P,O;P=new M.assignfeedback_editpdf.drawable(this.editor);O=this.editor.graphic.addShape({type:d.Path,fill:false,stroke:{weight:A,color:u[this.colour]}});O.moveTo(this.x,this.y);O.lineTo(this.endx,this.endy);O.end();P.shapes.push(O);this.drawable=P;return x.superclass.draw.apply(this)},draw_current_edit:function(Q){var P=new M.assignfeedback_editpdf.drawable(this.editor),O;O=this.editor.graphic.addShape({type:d.Path,fill:false,stroke:{weight:A,color:u[Q.annotationcolour]}});O.moveTo(Q.start.x,Q.start.y);O.lineTo(Q.end.x,Q.end.y);O.end();P.shapes.push(O);return P},init_from_edit:function(O){this.gradeid=this.editor.get("gradeid");this.pageno=this.editor.currentpage;this.x=O.start.x;this.y=O.start.y;this.endx=O.end.x;this.endy=O.end.y;this.colour=O.annotationcolour;this.path="";return !(((this.endx-this.x)===0)&&((this.endy-this.y)===0))}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotationline=x;var f=function(O){f.superclass.constructor.apply(this,[O])};f.NAME="annotationrectangle";f.ATTRS={};d.extend(f,M.assignfeedback_editpdf.annotation,{draw:function(){var P,Q,O;P=new M.assignfeedback_editpdf.drawable(this.editor);Q=new M.assignfeedback_editpdf.rect();Q.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]);O=this.editor.graphic.addShape({type:d.Rect,width:Q.width,height:Q.height,stroke:{weight:A,color:u[this.colour]},x:Q.x,y:Q.y});P.shapes.push(O);this.drawable=P;return f.superclass.draw.apply(this)},draw_current_edit:function(R){var P=new M.assignfeedback_editpdf.drawable(this.editor),O,Q;Q=new M.assignfeedback_editpdf.rect();Q.bound([new M.assignfeedback_editpdf.point(R.start.x,R.start.y),new M.assignfeedback_editpdf.point(R.end.x,R.end.y)]);if(!Q.has_min_width()){Q.set_min_width()}if(!Q.has_min_height()){Q.set_min_height()}O=this.editor.graphic.addShape({type:d.Rect,width:Q.width,height:Q.height,stroke:{weight:A,color:u[R.annotationcolour]},x:Q.x,y:Q.y});P.shapes.push(O);return P}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotationrectangle=f;var s=function(O){s.superclass.constructor.apply(this,[O])};s.NAME="annotationoval";s.ATTRS={};d.extend(s,M.assignfeedback_editpdf.annotation,{draw:function(){var P,Q,O;P=new M.assignfeedback_editpdf.drawable(this.editor);Q=new M.assignfeedback_editpdf.rect();Q.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]);O=this.editor.graphic.addShape({type:d.Ellipse,width:Q.width,height:Q.height,stroke:{weight:A,color:u[this.colour]},x:Q.x,y:Q.y});P.shapes.push(O);this.drawable=P;return s.superclass.draw.apply(this)},draw_current_edit:function(R){var P=new M.assignfeedback_editpdf.drawable(this.editor),O,Q;Q=new M.assignfeedback_editpdf.rect();Q.bound([new M.assignfeedback_editpdf.point(R.start.x,R.start.y),new M.assignfeedback_editpdf.point(R.end.x,R.end.y)]);if(!Q.has_min_width()){Q.set_min_width()}if(!Q.has_min_height()){Q.set_min_height()}O=this.editor.graphic.addShape({type:d.Ellipse,width:Q.width,height:Q.height,stroke:{weight:A,color:u[R.annotationcolour]},x:Q.x,y:Q.y});P.shapes.push(O);return P}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotationoval=s;var C=function(O){C.superclass.constructor.apply(this,[O])};C.NAME="annotationpen";C.ATTRS={};d.extend(C,M.assignfeedback_editpdf.annotation,{draw:function(){var Q,P,S,O,R;Q=new M.assignfeedback_editpdf.drawable(this.editor);P=this.editor.graphic.addShape({type:d.Path,fill:false,stroke:{weight:A,color:u[this.colour]}});S=true;O=this.path.split(":");d.each(O,function(T){R=T.split(",");if(S){P.moveTo(R[0],R[1]);S=false}else{P.lineTo(R[0],R[1])}},this);P.end();Q.shapes.push(P);this.drawable=Q;return C.superclass.draw.apply(this)},draw_current_edit:function(Q){var P=new M.assignfeedback_editpdf.drawable(this.editor),O,R;O=this.editor.graphic.addShape({type:d.Path,fill:false,stroke:{weight:A,color:u[Q.annotationcolour]}});R=true;d.each(Q.path,function(S){if(R){O.moveTo(S.x,S.y);R=false}else{O.lineTo(S.x,S.y)}},this);O.end();P.shapes.push(O);return P},init_from_edit:function(R){var Q=new M.assignfeedback_editpdf.rect(),O=[],P=0;Q.bound(R.path);for(P=0;P<R.path.length;P++){O.push(parseInt(R.path[P].x,10)+","+parseInt(R.path[P].y,10))}this.gradeid=this.editor.get("gradeid");this.pageno=this.editor.currentpage;this.x=Q.x;this.y=Q.y;this.endx=Q.x+Q.width;this.endy=Q.y+Q.height;this.colour=R.annotationcolour;this.path=O.join(":");return(Q.has_min_width()||Q.has_min_height())}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotationpen=C;var c=function(O){c.superclass.constructor.apply(this,[O])};c.NAME="annotationhighlight";c.ATTRS={};d.extend(c,M.assignfeedback_editpdf.annotation,{draw:function(){var P,O,R,Q;P=new M.assignfeedback_editpdf.drawable(this.editor);R=new M.assignfeedback_editpdf.rect();R.bound([new M.assignfeedback_editpdf.point(this.x,this.y),new M.assignfeedback_editpdf.point(this.endx,this.endy)]);Q=u[this.colour];Q=Q.replace("rgb","rgba");Q=Q.replace(")",",0.5)");O=this.editor.graphic.addShape({type:d.Rect,width:R.width,height:R.height,stroke:false,fill:{color:Q},x:R.x,y:R.y});P.shapes.push(O);this.drawable=P;return c.superclass.draw.apply(this)},draw_current_edit:function(S){var P=new M.assignfeedback_editpdf.drawable(this.editor),O,R,Q;R=new M.assignfeedback_editpdf.rect();R.bound([new M.assignfeedback_editpdf.point(S.start.x,S.start.y),new M.assignfeedback_editpdf.point(S.end.x,S.end.y)]);if(!R.has_min_width()){R.set_min_width()}Q=u[S.annotationcolour];Q=Q.replace("rgb","rgba");Q=Q.replace(")",",0.5)");O=this.editor.graphic.addShape({type:d.Rect,width:R.width,height:20,stroke:false,fill:{color:Q},x:R.x,y:S.start.y-10});P.shapes.push(O);return P},init_from_edit:function(P){var O=new M.assignfeedback_editpdf.rect();O.bound([P.start,P.end]);this.gradeid=this.editor.get("gradeid");this.pageno=this.editor.currentpage;this.x=O.x;this.y=P.start.y-10;this.endx=O.x+O.width;this.endy=P.start.y+10;this.colour=P.annotationcolour;this.page="";return(O.has_min_width())}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotationhighlight=c;var q=function(O){q.superclass.constructor.apply(this,[O])};q.NAME="annotationstamp";q.ATTRS={};d.extend(q,M.assignfeedback_editpdf.annotation,{draw:function(){var Q=new M.assignfeedback_editpdf.drawable(this.editor),P=this.editor.get_dialogue_element(g.DRAWINGCANVAS),R,O;O=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y));R=d.Node.create("<div/>");R.addClass("annotation");R.addClass("stamp");R.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(this.path)+")",width:(this.endx-this.x),height:(this.endy-this.y),backgroundSize:"100% 100%"});P.append(R);R.setX(O.x);R.setY(O.y);Q.store_position(R,O.x,O.y);if(!this.editor.get("readonly")){R.on("gesturemovestart",this.editor.edit_start,null,this.editor);R.on("gesturemove",this.editor.edit_move,null,this.editor);R.on("gesturemoveend",this.editor.edit_end,null,this.editor)}Q.nodes.push(R);this.drawable=Q;return q.superclass.draw.apply(this)},draw_current_edit:function(T){var S=new M.assignfeedback_editpdf.rect(),Q=new M.assignfeedback_editpdf.drawable(this.editor),P=this.editor.get_dialogue_element(g.DRAWINGREGION),R,O;S.bound([T.start,T.end]);O=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(S.x,S.y));R=d.Node.create("<div/>");R.addClass("annotation");R.addClass("stamp");R.setStyles({position:"absolute",display:"inline-block",backgroundImage:"url("+this.editor.get_stamp_image_url(T.stamp)+")",width:S.width,height:S.height,backgroundSize:"100% 100%"});P.append(R);R.setX(O.x);R.setY(O.y);Q.store_position(R,O.x,O.y);Q.nodes.push(R);return Q},init_from_edit:function(P){var O=new M.assignfeedback_editpdf.rect();O.bound([P.start,P.end]);if(O.width<40){O.width=40}if(O.height<40){O.height=40}this.gradeid=this.editor.get("gradeid");this.pageno=this.editor.currentpage;this.x=O.x;this.y=O.y;this.endx=O.x+O.width;this.endy=O.y+O.height;this.colour=P.annotationcolour;this.path=P.stamp;return true},move:function(R,Q){var P=R-this.x,O=Q-this.y;this.x+=P;this.y+=O;this.endx+=P;this.endy+=O;if(this.drawable){this.drawable.erase()}this.editor.drawables.push(this.draw())}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.annotationstamp=q;var l="Dropdown menu",N;N=function(O){O.draggable=false;O.centered=false;O.width="auto";O.visible=false;O.footerContent="";N.superclass.constructor.apply(this,[O])};d.extend(N,M.core.dialogue,{initializer:function(P){var Q,O,R,S;N.superclass.initializer.call(this,P);S=this.get("boundingBox");S.addClass("assignfeedback_editpdf_dropdown");Q=this.get("buttonNode");O=this.bodyNode;R=d.Node.create("<h3/>");R.addClass("accesshide");R.setHTML(this.get("headerText"));O.prepend(R);O.on("clickoutside",function(T){if(this.get("visible")){if(T.target.get("id")!==Q.get("id")&&T.target.ancestor().get("id")!==Q.get("id")){T.preventDefault();this.hide()}}},this);Q.on("click",function(T){T.preventDefault();this.show()},this);Q.on("key",this.show,"enter,space",this)},show:function(){var P=this.get("buttonNode"),O=N.superclass.show.call(this);this.align(P,[d.WidgetPositionAlign.TL,d.WidgetPositionAlign.BL]);return O}},{NAME:l,ATTRS:{headerText:{value:""},buttonNode:{value:null}}});d.Base.modifyAttrs(N,{modal:{getter:function(){return false}}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.dropdown=N;var o="Colourpicker",D;D=function(O){D.superclass.constructor.apply(this,[O])};d.extend(D,M.assignfeedback_editpdf.dropdown,{initializer:function(P){var Q=d.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>'),O;d.each(this.get("colours"),function(T,V){var U,X,W,S,R;W=M.util.get_string(V,"assignfeedback_editpdf");R=this.get("iconprefix")+V;S=M.util.image_url(R,"assignfeedback_editpdf");U=d.Node.create('<button><img alt="'+W+'" src="'+S+'"/></button>');U.setAttribute("data-colour",V);U.setAttribute("data-rgb",T);U.setStyle("backgroundImage","none");X=d.Node.create("<li/>");X.append(U);Q.append(X)},this);O=d.Node.create("<div/>");Q.delegate("click",this.callback_handler,"button",this);Q.delegate("key",this.callback_handler,"down:13","button",this);this.set("headerText",M.util.get_string("colourpicker","assignfeedback_editpdf"));O.append(Q);this.set("bodyContent",O);D.superclass.initializer.call(this,P)},callback_handler:function(P){P.preventDefault();var R=this.get("callback"),O=this.get("context"),Q;this.hide();Q=d.bind(R,O,P);Q()}},{NAME:o,ATTRS:{colours:{value:{}},callback:{value:null},context:{value:null},iconprefix:{value:"colour_"}}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.colourpicker=D;var n="Colourpicker",r;r=function(O){r.superclass.constructor.apply(this,[O])};d.extend(r,M.assignfeedback_editpdf.dropdown,{initializer:function(O){var P=d.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');d.each(this.get("stamps"),function(R){var Q,T,S;S=M.util.get_string("stamp","assignfeedback_editpdf");Q=d.Node.create('<button><img height="16" width="16" alt="'+S+'" src="'+R+'"/></button>');Q.setAttribute("data-stamp",R);Q.setStyle("backgroundImage","none");T=d.Node.create("<li/>");T.append(Q);P.append(T)},this);P.delegate("click",this.callback_handler,"button",this);P.delegate("key",this.callback_handler,"down:13","button",this);this.set("headerText",M.util.get_string("stamppicker","assignfeedback_editpdf"));this.set("bodyContent",P);r.superclass.initializer.call(this,O)},callback_handler:function(P){P.preventDefault();var R=this.get("callback"),O=this.get("context"),Q;this.hide();Q=d.bind(R,O,P);Q()}},{NAME:n,ATTRS:{stamps:{value:[]},callback:{value:null},context:{value:null}}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.stamppicker=r;var a="Commentmenu",j;j=function(O){j.superclass.constructor.apply(this,[O])};d.extend(j,M.assignfeedback_editpdf.dropdown,{initializer:function(P){var R,Q,O,S;S=this.get("comment");R=d.Node.create('<ul role="menu" class="assignfeedback_editpdf_menu"/>');Q=d.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("addtoquicklist","assignfeedback_editpdf")+"</a></li>");Q.on("click",S.add_to_quicklist,S);Q.on("key",S.add_to_quicklist,"enter,space",S);R.append(Q);Q=d.Node.create('<li><a tabindex="-1" href="#">'+M.util.get_string("deletecomment","assignfeedback_editpdf")+"</a></li>");Q.on("click",function(T){T.preventDefault();this.menu.hide();this.remove()},S);Q.on("key",function(){S.menu.hide();S.remove()},"enter,space",S);R.append(Q);Q=d.Node.create("<li><hr/></li>");R.append(Q);this.set("headerText",M.util.get_string("commentcontextmenu","assignfeedback_editpdf"));O=d.Node.create("<div/>");O.append(R);this.set("bodyContent",O);j.superclass.initializer.call(this,P)},show:function(){var O=this.get("boundingBox").one("ul");O.all(".quicklist_comment").remove(true);var P=this.get("comment");P.deleteme=false;d.each(P.editor.quicklist.comments,function(S){var T=d.Node.create('<li class="quicklist_comment"></li>'),R=d.Node.create('<a href="#" tabindex="-1">'+S.rawtext+"</a>"),Q=d.Node.create('<a href="#" tabindex="-1" class="delete_quicklist_comment"><img src="'+M.util.image_url("t/delete","core")+'" alt="'+M.util.get_string("deletecomment","assignfeedback_editpdf")+'"/></a>');R.setAttribute("title",S.rawtext);T.append(R);T.append(Q);O.append(T);T.on("click",P.set_from_quick_comment,P,S);T.on("key",P.set_from_quick_comment,"space,enter",P,S);Q.on("click",P.remove_from_quicklist,P,S);Q.on("key",P.remove_from_quicklist,"space,enter",P,S)},this);j.superclass.show.call(this)}},{NAME:a,ATTRS:{comment:{value:null}}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.commentmenu=j;var z="commentsearch",t;t=function(O){O.draggable=false;O.centered=true;O.width="400px";O.visible=false;O.headerContent=M.util.get_string("searchcomments","assignfeedback_editpdf");O.footerContent="";t.superclass.constructor.apply(this,[O])};d.extend(t,M.core.dialogue,{initializer:function(P){var R,O,U,Q,S,T;T=this.get("boundingBox");T.addClass("assignfeedback_editpdf_commentsearch");R=this.get("editor");O=d.Node.create("<div/>");U=M.util.get_string("filter","assignfeedback_editpdf");Q=d.Node.create('<input type="text" size="20" placeholder="'+U+'"/>');O.append(Q);S=d.Node.create('<ul role="menu" class="assignfeedback_editpdf_search"/>');O.append(S);Q.on("keyup",this.filter_search_comments,this);S.delegate("click",this.focus_on_comment,"a",this);S.delegate("key",this.focus_on_comment,"enter,space","a",this);this.set("bodyContent",O);t.superclass.initializer.call(this,P)},filter_search_comments:function(){var R,P,O,Q;Q=this.get("id");R=d.one("#"+Q+g.SEARCHFILTER);P=d.one("#"+Q+g.SEARCHCOMMENTSLIST);O=R.get("value");P.all("li").each(function(S){if(S.get("text").indexOf(O)!==-1){S.show()}else{S.hide()}})},focus_on_comment:function(Q){Q.preventDefault();var P=Q.target.ancestor("li"),R=P.getData("comment"),O=this.get("editor");this.hide();R.pageno=R.clean().pageno;if(R.pageno!==O.currentpage){O.currentpage=R.pageno;O.change_page()}R.node=R.drawable.nodes[0].one("textarea");R.node.ancestor("div").removeClass("commentcollapsed");R.node.focus()},show:function(){var P=this.get("boundingBox").one("ul"),O=this.get("editor");P.all("li").remove(true);d.each(O.pages,function(Q){d.each(Q.comments,function(S){var R=d.Node.create('<li><a href="#" tabindex="-1"><pre>'+S.rawtext+"</pre></a></li>");P.append(R);R.setData("comment",S)},this)},this);this.centerDialogue();t.superclass.show.call(this)}},{NAME:z,ATTRS:{editor:{value:null}}});d.Base.modifyAttrs(t,{modal:{getter:function(){return true}}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.commentsearch=t;var h=function(S,P,V,O,U,R,T,Q){this.editor=S;this.gradeid=P||0;this.x=parseInt(O,10)||0;this.y=parseInt(U,10)||0;this.width=parseInt(R,10)||0;this.rawtext=Q||"";this.pageno=V||0;this.colour=T||"yellow";this.drawable=false;this.deleteme=false;this.menulink=null;this.menu=null;this.clean=function(){return{gradeid:this.gradeid,x:parseInt(this.x,10),y:parseInt(this.y,10),width:parseInt(this.width,10),rawtext:this.rawtext,pageno:parseInt(this.pageno,10),colour:this.colour}};this.draw=function(af){var aa=new M.assignfeedback_editpdf.drawable(this.editor),Y,Z=this.editor.get_dialogue_element(g.DRAWINGCANVAS),W,ae,ab,X,ac,ad;Y=d.Node.create("<textarea/>");W=d.Node.create('<div class="commentdrawable"/>');ae=d.Node.create("<label/>");ab=d.Node.create('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-0.5 -0.5 13 13" preserveAspectRatio="xMinYMin meet"><path d="M11 0H1C.4 0 0 .4 0 1v6c0 .6.4 1 1 1h1v4l4-4h5c.6 0 1-.4 1-1V1c0-.6-.4-1-1-1z" fill="currentColor" opacity="0.9" stroke="rgb(153, 153, 153)" stroke-width="0.5"/></svg>');X=d.Node.create('<a href="#"><img src="'+M.util.image_url("t/contextmenu","core")+'"/></a>');this.menulink=X;W.append(ae);ae.append(Y);W.append(ab);W.setAttribute("tabindex","-1");ae.setAttribute("tabindex","0");Y.setAttribute("tabindex","-1");X.setAttribute("tabindex","0");if(!this.editor.get("readonly")){W.append(X)}else{Y.setAttribute("readonly","readonly")}if(this.width<100){this.width=100}ac=this.editor.get_window_coordinates(new M.assignfeedback_editpdf.point(this.x,this.y));Y.setStyles({width:this.width+"px",backgroundColor:m[this.colour],color:v});Z.append(W);W.setStyle("position","absolute");W.setX(ac.x);W.setY(ac.y);aa.store_position(W,ac.x,ac.y);aa.nodes.push(W);Y.set("value",this.rawtext);ad=Y.get("scrollHeight");Y.setStyles({height:ad+"px",overflow:"hidden"});ab.setStyle("color",m[this.colour]);this.attach_events(Y,X);if(af){Y.focus()}else{if(S.collapsecomments){W.addClass("commentcollapsed")}}this.drawable=aa;return aa};this.delete_comment_later=function(){if(this.deleteme){this.remove()}};this.attach_events=function(Z,aa){var X=Z.ancestor("div"),Y=Z.ancestor("label"),W=Y.next("svg");Z.collapse=function(ab){Z.collapse.delay=d.later(ab,Z,function(){if(S.collapsecomments){X.addClass("commentcollapsed")}})};Z.expand=function(){if(Z.getData("dragging")!==true){if(Z.collapse.delay){Z.collapse.delay.cancel()}X.removeClass("commentcollapsed")}};X.on("mouseenter",function(){if(S.currentedit.tool==="comment"||S.currentedit.tool==="select"||this.editor.get("readonly")){Z.expand()}},this);X.on("click|tap",function(){Z.expand();Z.focus()},this);Z.on("keyup",function(ab){if(ab.keyCode===9&&ab.shiftKey&&aa.getAttribute("tabindex")==="0"){aa.focus()}aa.setAttribute("tabindex","0")},this);aa.on("keydown",function(ab){if(ab.keyCode===9&&ab.shiftKey){aa.setAttribute("tabindex","-1")}},this);Y.on("focus",function(){Z.active=true;if(Z.collapse.delay){Z.collapse.delay.cancel()}Z.setAttribute("tabindex","0");Z.expand();Z.focus();Y.setAttribute("tabindex","-1")},this);aa.on("focus",function(){Z.active=true;if(Z.collapse.delay){Z.collapse.delay.cancel()}this.deleteme=false;Y.setAttribute("tabindex","0")},this);Z.on("blur",function(){Z.setAttribute("tabindex","-1")},this);Y.on("blur",function(){Y.setAttribute("tabindex","0")},this);X.on("mouseleave",function(){if(S.collapsecomments&&Z.active!==true){Z.collapse(400)}},this);X.on("blur",function(){Z.active=false;Z.collapse(800)},this);if(!this.editor.get("readonly")){Z.on("blur",function(){this.rawtext=Z.get("value");this.width=parseInt(Z.getStyle("width"),10);if(this.rawtext.replace(/^\s+|\s+$/g,"")===""){this.deleteme=true;d.later(400,this,this.delete_comment_later)}this.editor.save_current_page();this.editor.editingcomment=false},this);aa.setData("comment",this);Z.on("keyup",function(){Z.setStyle("height","auto");var ac=Z.get("scrollHeight"),ab=parseInt(Z.getStyle("height"),10);if(ac===ab+8){ac-=8}Z.setStyle("height",ac+"px")});Z.on("gesturemovestart",function(ab){if(S.currentedit.tool==="select"){ab.preventDefault();if(S.collapsecomments){Z.setData("offsetx",8);Z.setData("offsety",8)}else{Z.setData("offsetx",ab.clientX-X.getX());Z.setData("offsety",ab.clientY-X.getY())}}});Z.on("gesturemove",function(af){if(S.currentedit.tool==="select"){var ab=af.clientX-Z.getData("offsetx"),ag=af.clientY-Z.getData("offsety"),ad,ae,ac;if(Z.getData("dragging")!==true){Z.collapse(0);Z.setData("dragging",true)}ad=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(ab,ag));ac=this.editor.get_canvas_bounds(true);ac.x=0;ac.y=0;ac.width-=24;ac.height-=24;ad.clip(ac);this.x=ad.x;this.y=ad.y;ae=this.editor.get_window_coordinates(ad);X.setX(ae.x);X.setY(ae.y);this.drawable.store_position(X,ae.x,ae.y)}},null,this);Z.on("gesturemoveend",function(){if(S.currentedit.tool==="select"){if(Z.getData("dragging")===true){Z.setData("dragging",false)}this.editor.save_current_page()}},null,this);W.on("gesturemovestart",function(ab){if(S.currentedit.tool==="select"){ab.preventDefault();Z.setData("offsetx",ab.clientX-X.getX());Z.setData("offsety",ab.clientY-X.getY());Z.expand()}});W.on("gesturemove",function(af){if(S.currentedit.tool==="select"){var ab=af.clientX-Z.getData("offsetx"),ag=af.clientY-Z.getData("offsety"),ad,ae,ac;if(Z.getData("dragging")!==true){Z.collapse(100);Z.setData("dragging",true)}ad=this.editor.get_canvas_coordinates(new M.assignfeedback_editpdf.point(ab,ag));ac=this.editor.get_canvas_bounds(true);ac.x=0;ac.y=0;ac.width-=24;ac.height-=24;ad.clip(ac);this.x=ad.x;this.y=ad.y;ae=this.editor.get_window_coordinates(ad);X.setX(ae.x);X.setY(ae.y);this.drawable.store_position(X,ae.x,ae.y)}},null,this);W.on("gesturemoveend",function(){if(S.currentedit.tool==="select"){if(Z.getData("dragging")===true){Z.setData("dragging",false)}this.editor.save_current_page()}},null,this);this.menu=new M.assignfeedback_editpdf.commentmenu({buttonNode:this.menulink,comment:this})}};this.remove=function(){var W=0;var X;X=this.editor.pages[this.editor.currentpage].comments;for(W=0;W<X.length;W++){if(X[W]===this){X.splice(W,1);this.drawable.erase();this.editor.save_current_page();return}}};this.remove_from_quicklist=function(X,W){X.preventDefault();X.stopPropagation();this.menu.hide();this.editor.quicklist.remove(W)};this.set_from_quick_comment=function(X,W){X.preventDefault();this.menu.hide();this.deleteme=false;this.rawtext=W.rawtext;this.width=W.width;this.colour=W.colour;this.editor.save_current_page();this.editor.redraw();this.node=this.drawable.nodes[0].one("textarea");this.node.ancestor("div").removeClass("commentcollapsed");this.node.focus()};this.add_to_quicklist=function(W){W.preventDefault();this.menu.hide();this.editor.quicklist.add(this)};this.draw_current_edit=function(Z){var X=new M.assignfeedback_editpdf.drawable(this.editor),W,Y;Y=new M.assignfeedback_editpdf.rect();Y.bound([Z.start,Z.end]);W=this.editor.graphic.addShape({type:d.Rect,width:Y.width,height:Y.height,fill:{color:m[Z.commentcolour]},x:Y.x,y:Y.y});X.shapes.push(W);return X};this.init_from_edit=function(X){var W=new M.assignfeedback_editpdf.rect();W.bound([X.start,X.end]);if(W.width<100){W.width=100}this.gradeid=this.editor.get("gradeid");this.pageno=this.editor.currentpage;this.x=W.x;this.y=W.y;this.width=W.width;this.colour=X.commentcolour;this.rawtext="";return(W.has_min_width()&&W.has_min_height())};this.updatePosition=function(){var Y=this.drawable.nodes[0].one("textarea");var W=Y.ancestor("div");var X=new M.assignfeedback_editpdf.point(this.x,this.y);var Z=this.editor.get_window_coordinates(X);W.setX(Z.x);W.setY(Z.y);this.drawable.store_position(W,Z.x,Z.y)}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.comment=h;var w=function(R,O,P,Q){this.rawtext=O||"";this.id=R||0;this.width=P||100;this.colour=Q||"yellow"};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.quickcomment=w;var i=function(O){this.editor=O;this.comments=[];this.add=function(R){var Q=y,P;if(R.rawtext===""){return}P={method:"post",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"addtoquicklist",userid:this.editor.get("userid"),commenttext:R.rawtext,width:R.width,colour:R.colour,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(W,S){var V,T;try{V=d.JSON.parse(S.responseText);if(V.error){return new M.core.ajaxException(V)}else{T=new M.assignfeedback_editpdf.quickcomment(V.id,V.rawtext,V.width,V.colour);this.comments.push(T);this.comments.sort(function(Y,X){return Y.rawtext.localeCompare(X.rawtext)})}}catch(U){return new M.core.exception(U)}},failure:function(T,S){return M.core.exception(S.responseText)}}};d.io(Q,P)};this.remove=function(R){var Q=y,P;if(!R){return}P={method:"post",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"removefromquicklist",userid:this.editor.get("userid"),commentid:R.id,attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(){var S;S=this.comments.indexOf(R);if(S>=0){this.comments.splice(S,1)}},failure:function(T,S){return M.core.exception(S.responseText)}}};d.io(Q,P)};this.load=function(){var Q=y,P;P={method:"get",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"loadquicklist",userid:this.editor.get("userid"),attemptnumber:this.editor.get("attemptnumber"),assignmentid:this.editor.get("assignmentid")},on:{success:function(U,R){var T;try{T=d.JSON.parse(R.responseText);if(T.error){return new M.core.ajaxException(T)}else{d.each(T,function(W){var V=new M.assignfeedback_editpdf.quickcomment(W.id,W.rawtext,W.width,W.colour);this.comments.push(V)},this);this.comments.sort(function(W,V){return W.rawtext.localeCompare(V.rawtext)})}}catch(S){return new M.core.exception(S)}},failure:function(S,R){return M.core.exception(R.responseText)}}};d.io(Q,P)}};M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.quickcommentlist=i;var B=function(){B.superclass.constructor.apply(this,arguments)};B.prototype={oldannotationcoordinates:null,dialogue:null,panel:null,pagecount:0,currentpage:0,pages:[],documentstatus:0,loadingicon:null,pageimage:null,graphic:null,currentedit:new M.assignfeedback_editpdf.edit(),currentdrawable:false,drawables:[],currentcomment:null,currentannotation:null,lastannotation:null,lastannotationtool:"pen",quicklist:null,searchcommentswindow:null,currentstamp:null,stamps:[],editingcomment:false,lastscrolltime:0,collapsecomments:true,initializer:function(){var O;O=d.one("#"+this.get("linkid"));if(O){O.on("click",this.link_handler,this);O.on("key",this.link_handler,"down:13",this);require(["mod_assign/grading_review_panel"],function(R){var Q=new R();var P=Q.getReviewPanel("assignfeedback_editpdf");if(P){P=d.one(P);P.empty();O.ancestor(".fitem").hide();this.open_in_panel(P)}this.currentedit.start=false;this.currentedit.end=false;if(!this.get("readonly")){this.quicklist=new M.assignfeedback_editpdf.quickcommentlist(this)}}.bind(this))}},refresh_button_state:function(){var R,T,P,O,S,Q;R=this.get_dialogue_element(g.COMMENTCOLOURBUTTON);P=M.util.image_url("background_colour_"+this.currentedit.commentcolour,"assignfeedback_editpdf");R.one("img").setAttribute("src",P);if(this.currentedit.commentcolour==="clear"){R.one("img").setStyle("borderStyle","dashed")}else{R.one("img").setStyle("borderStyle","solid")}R=this.get_dialogue_element(g.ANNOTATIONCOLOURBUTTON);P=M.util.image_url("colour_"+this.currentedit.annotationcolour,"assignfeedback_editpdf");R.one("img").setAttribute("src",P);T=this.get_dialogue_element(F[this.currentedit.tool]);T.addClass("assignfeedback_editpdf_selectedbutton");T.setAttribute("aria-pressed","true");O=this.get_dialogue_element(g.DRAWINGREGION);O.setAttribute("data-currenttool",this.currentedit.tool);R=this.get_dialogue_element(g.STAMPSBUTTON);S=this.get_stamp_image_url(this.currentedit.stamp);R.one("img").setAttrs({src:S,height:"16",width:"16"});Q=this.get_dialogue_element(g.DRAWINGCANVAS);switch(this.currentedit.tool){case"drag":Q.setStyle("cursor","move");break;case"highlight":Q.setStyle("cursor","text");break;case"select":Q.setStyle("cursor","default");break;case"stamp":Q.setStyle("cursor","url("+S+"), crosshair");break;default:Q.setStyle("cursor","crosshair")}},get_canvas_bounds:function(){var P=this.get_dialogue_element(g.DRAWINGCANVAS),R=P.getXY(),T=R[0],S=R[1],Q=parseInt(P.getStyle("width"),10),O=parseInt(P.getStyle("height"),10);return new M.assignfeedback_editpdf.rect(T,S,Q,O)},get_canvas_coordinates:function(O){var Q=this.get_canvas_bounds(),P=new M.assignfeedback_editpdf.point(O.x-Q.x,O.y-Q.y);Q.x=Q.y=0;P.clip(Q);return P},get_window_coordinates:function(O){var Q=this.get_canvas_bounds(),P=new M.assignfeedback_editpdf.point(O.x+Q.x,O.y+Q.y);return P},open_in_panel:function(P){var Q,O;this.panel=P;P.append(this.get("body"));P.addClass(p.DIALOGUE);this.loadingicon=this.get_dialogue_element(g.LOADINGICON);Q=this.get_dialogue_element(g.DRAWINGCANVAS);this.graphic=new d.Graphic({render:Q});O=this.get_dialogue_element(g.DRAWINGREGION);O.on("scroll",this.simulate_scroll,this);if(!this.get("readonly")){Q.on("gesturemovestart",this.edit_start,null,this);Q.on("gesturemove",this.edit_move,null,this);Q.on("gesturemoveend",this.edit_end,null,this);this.refresh_button_state()}this.start_generation()},link_handler:function(R){var Q,O;var P=true;R.preventDefault();if(!this.dialogue){this.dialogue=new M.core.dialogue({headerContent:this.get("header"),bodyContent:this.get("body"),footerContent:this.get("footer"),modal:true,width:"840px",visible:false,draggable:true});this.dialogue.get("boundingBox").addClass(p.DIALOGUE);this.loadingicon=this.get_dialogue_element(g.LOADINGICON);Q=this.get_dialogue_element(g.DRAWINGCANVAS);this.graphic=new d.Graphic({render:Q});O=this.get_dialogue_element(g.DRAWINGREGION);O.on("scroll",this.simulate_scroll,this);if(!this.get("readonly")){Q.on("gesturemovestart",this.edit_start,null,this);Q.on("gesturemove",this.edit_move,null,this);Q.on("gesturemoveend",this.edit_end,null,this);this.refresh_button_state()}this.start_generation();Q.on("windowresize",this.resize,this);P=false}this.dialogue.centerDialogue();this.dialogue.show();this.dialogue.dd.on("drag:end",this.redraw,this);if(P){this.resize()}},start_generation:function(){this.poll_document_conversion_status()},poll_document_conversion_status:function(){var O=this.get("userid");d.io(y,{method:"get",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(T,Q){var P=d.one(g.USERINFOREGION);if(P){var R=P.getAttribute("data-userid");if(R&&(R!=O)){return}}var S=this.handle_response_data(Q),U=false;if(S){this.documentstatus=S.status;if(S.status===0){U=true}else{if(S.status===1||S.status===3){U=true}else{if(S.status===2||S.status===-1){this.pagecount=S.pagecount;if(S.pageready==S.pagecount){this.prepare_pages_for_display(S)}else{this.update_page_load_progress();this.start_document_to_image_conversion()}}}}if(U){d.later(1000,this,this.poll_document_conversion_status)}}},failure:function(Q,P){return new M.core.exception(P.responseText)}}})},start_document_to_image_conversion:function(){d.io(y,{method:"get",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"pollconversions",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),readonly:this.get("readonly")?1:0},on:{success:function(Q,O){var P=this.handle_response_data(O);if(P){this.documentstatus=P.status;if(P.status===2){this.prepare_pages_for_display(P)}}},failure:function(P,O){return new M.core.exception(O.responseText)}}})},warning:function(R,V){var P=this.get_dialogue_element(g.ICONMESSAGECONTAINER);var U=this.get_dialogue_element(g.WARNINGMESSAGECONTAINER);var Q=15,T=1;var S="assignfeedback_editpdf_warningmessages alert alert-warning";if(V){Q=4;S="assignfeedback_editpdf_warningmessages alert alert-info"}var O=d.Node.create('<div class="'+S+'" role="alert"></div>');O.append(P.one("*").cloneNode());O.append(R);U.prepend(O);O.transition({duration:T,delay:Q,opacity:0},function(){O.remove()})},prepare_pages_for_display:function(T){var S,R,U,Q,O,P;if(!T.pagecount){if(this.dialogue){this.dialogue.hide()}Q=new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf")});Q.show();return}this.pages=T.pages;for(S=0;S<this.pages.length;S++){for(R=0;R<this.pages[S].comments.length;R++){U=this.pages[S].comments[R];this.pages[S].comments[R]=new M.assignfeedback_editpdf.comment(this,U.gradeid,U.pageno,U.x,U.y,U.width,U.colour,U.rawtext)}for(R=0;R<this.pages[S].annotations.length;R++){O=this.pages[S].annotations[R];this.pages[S].annotations[R]=this.create_annotation(O.type,O)}}P=this.get("readonly");if(!P&&T.partial){this.warning(M.util.get_string("partialwarning","assignfeedback_editpdf"),false)}if(this.quicklist){this.quicklist.load()}this.setup_navigation();this.setup_toolbar();this.change_page()},update_page_load_progress:function(){var Q,P=0,O=this.get_dialogue_element(g.PROGRESSBARCONTAINER+" .bar");if(!O){return}Q={method:"get",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"conversionstatus",userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid")},on:{success:function(U,S){P=0;var T=0;var R=this.get_dialogue_element(g.PROGRESSBARCONTAINER+" .bar");if(R){T=(S.response/this.pagecount)*100;R.setStyle("width",T+"%");R.ancestor(g.PROGRESSBARCONTAINER).setAttribute("aria-valuenow",T);if(T<100){M.util.js_pending("checkconversionstatus");d.later(1000,this,function(){M.util.js_complete("checkconversionstatus");d.io(K,Q)})}}},failure:function(S,R){P=P+1;if(this.pagecount===0&&P<5){M.util.js_pending("checkconversionstatus");d.later(1000,this,function(){M.util.js_complete("checkconversionstatus");d.io(K,Q)})}return new M.core.exception(R.responseText)}}};M.util.js_pending("checkconversionstatus");d.later(1000,this,function(){P=0;M.util.js_complete("checkconversionstatus");d.io(K,Q)})},handle_response_data:function(O){var P;try{P=d.JSON.parse(O.responseText);if(P.error){if(this.dialogue){this.dialogue.hide()}new M.core.alert({message:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:true})}else{return P}}catch(Q){if(this.dialogue){this.dialogue.hide()}new M.core.alert({title:M.util.get_string("cannotopenpdf","assignfeedback_editpdf"),visible:true})}return},get_stamp_image_url:function(O){var Q=this.get("stampfiles"),P="";d.Array.each(Q,function(R){if(R.indexOf(O)>0){P=R}},this);return P},setup_toolbar:function(){var R,W,Y,T,U,S,Q,P,X,V,O;T=this.get_dialogue_element(g.SEARCHCOMMENTSBUTTON);T.on("click",this.open_search_comments,this);T.on("key",this.open_search_comments,"down:13",this);U=this.get_dialogue_element(g.EXPCOLCOMMENTSBUTTON);U.on("click",this.expandCollapseComments,this);U.on("key",this.expandCollapseComments,"down:13",this);if(this.get("readonly")){return}S=this.get_dialogue_element(g.ROTATELEFTBUTTON);S.on("click",this.rotatePDF,this,true);S.on("key",this.rotatePDF,"down:13",this,true);Q=this.get_dialogue_element(g.ROTATERIGHTBUTTON);Q.on("click",this.rotatePDF,this,false);Q.on("key",this.rotatePDF,"down:13",this,false);this.disable_touch_scroll();d.each(F,function(Z,aa){R=this.get_dialogue_element(Z);R.on("click",this.handle_tool_button,this,aa);R.on("key",this.handle_tool_button,"down:13",this,aa);R.setAttribute("aria-pressed","false")},this);W=this.get_dialogue_element(g.COMMENTCOLOURBUTTON);V=new M.assignfeedback_editpdf.colourpicker({buttonNode:W,colours:m,iconprefix:"background_colour_",callback:function(aa){var Z=aa.target.getAttribute("data-colour");if(!Z){Z=aa.target.ancestor().getAttribute("data-colour")}this.currentedit.commentcolour=Z;this.handle_tool_button(aa,"comment")},context:this});Y=this.get_dialogue_element(g.ANNOTATIONCOLOURBUTTON);V=new M.assignfeedback_editpdf.colourpicker({buttonNode:Y,iconprefix:"colour_",colours:u,callback:function(aa){var Z=aa.target.getAttribute("data-colour");if(!Z){Z=aa.target.ancestor().getAttribute("data-colour")}this.currentedit.annotationcolour=Z;if(this.lastannotationtool){this.handle_tool_button(aa,this.lastannotationtool)}else{this.handle_tool_button(aa,"pen")}},context:this});X=this.get("stampfiles");if(X.length<=0){this.get_dialogue_element(F.stamp).ancestor().hide()}else{O=X[0].substr(X[0].lastIndexOf("/")+1);this.currentedit.stamp=O;P=this.get_dialogue_element(g.STAMPSBUTTON);V=new M.assignfeedback_editpdf.stamppicker({buttonNode:P,stamps:X,callback:function(ab){var aa=ab.target.getAttribute("data-stamp"),Z;if(!aa){aa=ab.target.ancestor().getAttribute("data-stamp")}Z=aa.substr(aa.lastIndexOf("/"));this.currentedit.stamp=Z;this.handle_tool_button(ab,"stamp")},context:this});this.refresh_button_state()}},handle_tool_button:function(Q,O){var P;Q.preventDefault();P=this.get_dialogue_element(F[this.currentedit.tool]);P.removeClass("assignfeedback_editpdf_selectedbutton");P.setAttribute("aria-pressed","false");this.currentedit.tool=O;if(O!=="comment"&&O!=="select"&&O!=="drag"&&O!=="stamp"){this.lastannotationtool=O}this.refresh_button_state()},stringify_current_page:function(){var R=[],Q=[],P,O=0;for(O=0;O<this.pages[this.currentpage].comments.length;O++){R[O]=this.pages[this.currentpage].comments[O].clean()}for(O=0;O<this.pages[this.currentpage].annotations.length;O++){Q[O]=this.pages[this.currentpage].annotations[O].clean()}P={comments:R,annotations:Q};return d.JSON.stringify(P)},get_current_drawable:function(){var Q,O,P=false;if(!this.currentedit.start||!this.currentedit.end){return false}if(this.currentedit.tool==="comment"){Q=new M.assignfeedback_editpdf.comment(this);P=Q.draw_current_edit(this.currentedit)}else{O=this.create_annotation(this.currentedit.tool,{});if(O){P=O.draw_current_edit(this.currentedit)}}return P},get_dialogue_element:function(O){if(this.panel){return this.panel.one(O)}else{return this.dialogue.get("boundingBox").one(O)}},redraw_current_edit:function(){if(this.currentdrawable){this.currentdrawable.erase()}this.currentdrawable=this.get_current_drawable()},edit_start:function(T){var P=this.get_dialogue_element(g.DRAWINGCANVAS),Q=P.getXY(),O=P.get("docScrollY"),X=P.get("docScrollX"),W={x:T.clientX-Q[0]+X,y:T.clientY-Q[1]+O},R=false;if(T.button===3){return}if(this.currentedit.starttime){return}if(this.editingcomment){return}this.currentedit.starttime=new Date().getTime();this.currentedit.start=W;this.currentedit.end={x:W.x,y:W.y};if(this.currentedit.tool==="select"){var V=this.currentedit.end.x,U=this.currentedit.end.y,S=this.pages[this.currentpage].annotations;d.each(S,function(Y){if(((V-Y.x)*(V-Y.endx))<=0&&((U-Y.y)*(U-Y.endy))<=0){R=Y}});if(R){this.lastannotation=this.currentannotation;this.currentannotation=R;if(this.lastannotation&&this.lastannotation!==R){if(this.lastannotation.drawable){this.lastannotation.drawable.erase();this.drawables.push(this.lastannotation.draw())}}if(this.currentannotation.drawable){this.currentannotation.drawable.erase()}this.drawables.push(this.currentannotation.draw())}else{this.lastannotation=this.currentannotation;this.currentannotation=null;if(this.lastannotation&&this.lastannotation.drawable){this.lastannotation.drawable.erase();this.drawables.push(this.lastannotation.draw())}}}if(this.currentannotation){this.currentedit.annotationstart={x:this.currentannotation.x,y:this.currentannotation.y}}},edit_move:function(U){U.preventDefault();var T=this.get_canvas_bounds(),S=this.get_dialogue_element(g.DRAWINGCANVAS),P=this.get_dialogue_element(g.DRAWINGREGION),V=new M.assignfeedback_editpdf.point(U.clientX+S.get("docScrollX"),U.clientY+S.get("docScrollY")),O=this.get_canvas_coordinates(V),R,Q;if(O.x<0||O.x>T.width||O.y<0||O.y>T.height){return}if(this.currentedit.tool==="pen"){this.currentedit.path.push(O)}if(this.currentedit.tool==="select"){if(this.currentannotation&&this.currentedit){this.currentannotation.move(this.currentedit.annotationstart.x+O.x-this.currentedit.start.x,this.currentedit.annotationstart.y+O.y-this.currentedit.start.y)}}else{if(this.currentedit.tool==="drag"){R=O.x-this.currentedit.start.x;Q=O.y-this.currentedit.start.y;P.getDOMNode().scrollLeft-=R;P.getDOMNode().scrollTop-=Q}else{if(this.currentedit.start){this.currentedit.end=O;this.redraw_current_edit()}}}},edit_end:function(){var P,Q,O;P=new Date().getTime()-this.currentedit.start;if(P<k||this.currentedit.start===false){return}if(this.currentedit.tool==="comment"){if(this.currentdrawable){this.currentdrawable.erase()}this.currentdrawable=false;Q=new M.assignfeedback_editpdf.comment(this);if(Q.init_from_edit(this.currentedit)){this.pages[this.currentpage].comments.push(Q);this.drawables.push(Q.draw(true));this.editingcomment=true}}else{O=this.create_annotation(this.currentedit.tool,{});if(O){if(this.currentdrawable){this.currentdrawable.erase()}this.currentdrawable=false;if(O.init_from_edit(this.currentedit)){this.pages[this.currentpage].annotations.push(O);this.drawables.push(O.draw())}}}this.save_current_page();this.currentedit.starttime=0;this.currentedit.start=false;this.currentedit.end=false;this.currentedit.path=[]},resize:function(){var O,P;if(this.dialogue){if(!this.dialogue.get("visible")){return}this.dialogue.centerDialogue()}P=d.one("body").get("winHeight")-120;if(P<100){P=100}O=this.get_dialogue_element(g.DRAWINGREGION);if(this.dialogue){O.setStyle("maxHeight",P+"px")}this.redraw();return true},create_annotation:function(O,P){P.type=O;P.editor=this;if(O==="line"){return new M.assignfeedback_editpdf.annotationline(P)}else{if(O==="rectangle"){return new M.assignfeedback_editpdf.annotationrectangle(P)}else{if(O==="oval"){return new M.assignfeedback_editpdf.annotationoval(P)}else{if(O==="pen"){return new M.assignfeedback_editpdf.annotationpen(P)}else{if(O==="highlight"){return new M.assignfeedback_editpdf.annotationhighlight(P)}else{if(O==="stamp"){return new M.assignfeedback_editpdf.annotationstamp(P)}}}}}}return false},save_current_page:function(){this.clear_warnings(false);var P=y,O;O={method:"post",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"savepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),page:this.stringify_current_page()},on:{success:function(T,Q){var S;try{S=d.JSON.parse(Q.responseText);if(S.error){return new M.core.ajaxException(S)}d.one(g.UNSAVEDCHANGESINPUT).set("value","true");this.warning(M.util.get_string("draftchangessaved","assignfeedback_editpdf"),true)}catch(R){return new M.core.exception(R)}},failure:function(R,Q){return new M.core.exception(Q.responseText)}}};d.io(P,O)},open_search_comments:function(O){if(!this.searchcommentswindow){this.searchcommentswindow=new M.assignfeedback_editpdf.commentsearch({editor:this})}this.searchcommentswindow.show();O.preventDefault()},expandCollapseComments:function(){var O=d.all(".commentdrawable");if(this.collapsecomments){this.collapsecomments=false;O.removeClass("commentcollapsed")}else{this.collapsecomments=true;O.addClass("commentcollapsed")}},redraw:function(){var O,P;P=this.pages[this.currentpage];if(P===undefined){return}while(this.drawables.length>0){this.drawables.pop().erase()}for(O=0;O<P.annotations.length;O++){this.drawables.push(P.annotations[O].draw())}for(O=0;O<P.comments.length;O++){this.drawables.push(P.comments[O].draw(false))}},clear_warnings:function(P){var O=this.get_dialogue_element(g.WARNINGMESSAGECONTAINER);if(P){O.empty()}else{O.all(".alert-info").remove(true)}},change_page:function(){var T=this.get_dialogue_element(g.DRAWINGCANVAS),U,S,R,P,O,Q,V;Q=this.get_dialogue_element(g.PREVIOUSBUTTON);V=this.get_dialogue_element(g.NEXTBUTTON);S=false;R=1;P=O="";if(this.currentpage>0){Q.removeAttribute("disabled")}else{Q.setAttribute("disabled","true")}if(this.currentpage<(this.pagecount-1)){V.removeAttribute("disabled");S=this.pages[this.currentpage+1]}else{V.setAttribute("disabled","true")}U=this.pages[this.currentpage];P='url("'+U.url+'")';O="0 0";if(S){P+=', url("'+S.url+'")';O+=", 0 "+U.height+"px";R++}if(this.loadingicon){this.loadingicon.hide()}T.setStyle("backgroundImage",P);T.setStyle("backgroundPosition",O);T.setStyle("width",U.width+"px");T.setStyle("height",U.height*R+"px");T.scrollIntoView();this.get_dialogue_element(g.PAGESELECT).set("selectedIndex",this.currentpage);this.resize()},setup_navigation:function(){var T,R,O,S,Q,U;T=this.get_dialogue_element(g.PAGESELECT);var P=T.all("option");if(P.size()<=1){for(R=0;R<this.pages.length;R++){S=d.Node.create("<option/>");S.setAttribute("value",R);O={page:R+1,total:this.pages.length};S.setHTML(M.util.get_string("pagexofy","assignfeedback_editpdf",O));T.append(S)}}T.removeAttribute("disabled");T.on("change",function(){this.currentpage=T.get("value");this.clear_warnings(false);this.change_page()},this);Q=this.get_dialogue_element(g.PREVIOUSBUTTON);U=this.get_dialogue_element(g.NEXTBUTTON);Q.on("click",this.previous_page,this);Q.on("key",this.previous_page,"down:13",this);U.on("click",this.next_page,this);U.on("key",this.next_page,"down:13",this)},previous_page:function(O){O.preventDefault();this.currentpage--;if(this.currentpage<0){this.currentpage=0}this.clear_warnings(false);this.change_page()},next_page:function(O){O.preventDefault();this.currentpage++;if(this.currentpage>=this.pages.length){this.currentpage=this.pages.length-1}this.clear_warnings(false);this.change_page()},skip_scroll:function(O,Q,P){if(P==0||P==Q-1){O.set("scrollTop",Q-1);return true}if(P>Q){O.set("scrollTop",1);return true}return false},simulate_scroll:function(){var O,Q,S,R,P;O=this.get_dialogue_element(g.DRAWINGREGION);R=this.pages[this.currentpage];P=O.get("scrollTop");if(this.lastscrolltime>=(Date.now()-500)&&this.skip_scroll(O,R.height,P)){return}if(P>=R.height&&this.currentpage<this.pages.length-1){this.lastscrolltime=Date.now();S=this.get_dialogue_element(g.NEXTBUTTON);S.simulate("click");O.set("scrollTop",1);return}if(P<=0&&this.currentpage>0){this.lastscrolltime=Date.now();Q=this.get_dialogue_element(g.PREVIOUSBUTTON);Q.simulate("click");O.set("scrollTop",R.height-1);return}},move_canvas:function(){var P,O,R,Q;P=this.get_dialogue_element(g.DRAWINGREGION);O=parseInt(P.get("scrollLeft"),10);R=parseInt(P.get("scrollTop"),10);for(Q=0;Q<this.drawables.length;Q++){this.drawables[Q].scroll_update(O,R)}},rotatePDF:function(U,T){U.preventDefault();if(this.get("destroyed")){return}var O=this;var Q;this.oldannotationcoordinates=[];var S=this.pages[this.currentpage].annotations;for(Q=0;Q<S.length;Q++){var R=S[Q];this.oldannotationcoordinates.push([R.x,R.y])}var V=y;var P={method:"post",context:this,sync:false,data:{sesskey:M.cfg.sesskey,action:"rotatepage",index:this.currentpage,userid:this.get("userid"),attemptnumber:this.get("attemptnumber"),assignmentid:this.get("assignmentid"),rotateleft:T},on:{success:function(Z,aa){var ab;try{ab=d.JSON.parse(aa.responseText);var af=O.pages[O.currentpage];af.url=ab.page.url;af.width=ab.page.width;af.height=ab.page.height;O.loadingicon.hide();var X=O.get_dialogue_element(g.DRAWINGCANVAS);X.setStyle("backgroundImage",'url("'+af.url+'")');X.setStyle("width",af.width+"px");X.setStyle("height",af.height+"px");var ac;var ad=af.annotations;for(ac=0;ac<ad.length;ac++){if(O.oldannotationcoordinates&&O.oldannotationcoordinates[ac]){var ah=O.oldannotationcoordinates[ac][0];var ag=O.oldannotationcoordinates[ac][1];var Y=ad[ac];Y.move(ah,ag)}}var W=af.comments;for(ac=0;ac<W.length;ac++){W[ac].updatePosition()}return O.save_current_page()}catch(ae){return new M.core.exception(ae)}},failure:function(X,W){return new M.core.exception(W.responseText)}}};d.io(V,P)},event_listener_options_supported:function(){var P=false,O,R="testpassiveeventoptions";try{O=Object.defineProperty({},"passive",{get:function(){P=true}});document.addEventListener(R,O,O);document.removeEventListener(R,O,O)}catch(Q){P=false}return P},disable_touch_scroll:function(){if(this.event_listener_options_supported()){document.addEventListener("touchmove",this.stop_touch_scroll.bind(this),{passive:false})}},stop_touch_scroll:function(P){var O=this.get_dialogue_element(g.DRAWINGREGION);if(O.contains(P.target)){P.stopPropagation();P.preventDefault()}}};d.extend(B,d.Base,B.prototype,{NAME:"moodle-assignfeedback_editpdf-editor",ATTRS:{userid:{validator:d.Lang.isInteger,value:0},assignmentid:{validator:d.Lang.isInteger,value:0},attemptnumber:{validator:d.Lang.isInteger,value:0},header:{validator:d.Lang.isString,value:""},body:{validator:d.Lang.isString,value:""},footer:{validator:d.Lang.isString,value:""},linkid:{validator:d.Lang.isString,value:""},deletelinkid:{validator:d.Lang.isString,value:""},readonly:{validator:d.Lang.isBoolean,value:true},stampfiles:{validator:d.Lang.isArray,value:""}}});M.assignfeedback_editpdf=M.assignfeedback_editpdf||{};M.assignfeedback_editpdf.editor=M.assignfeedback_editpdf.editor||{};M.assignfeedback_editpdf.editor.init=M.assignfeedback_editpdf.editor.init||function(O){M.assignfeedback_editpdf.instance=new B(O);return M.assignfeedback_editpdf.instance}},"@VERSION@",{requires:["base","event","node","io","graphics","json","event-move","event-resize","transition","querystring-stringify-simple","moodle-core-notification-dialog","moodle-core-notification-alert","moodle-core-notification-warning","moodle-core-notification-exception","moodle-core-notification-ajaxexception"]});